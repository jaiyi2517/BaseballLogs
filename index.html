<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°é­çš„é‡çƒæ•¸æ“š</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        paper: '#F9F4EB',
                        primary: '#736357',
                        sage: '#8CA694',
                        slate: '#88A6B0',
                        accent: '#D97C6E'
                    },
                    fontFamily: {
                        serif: ['"Noto Serif TC"', 'serif'],
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Chart.js & Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <!-- SheetJS (XLSX) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style type="text/tailwindcss">
        body {
            background-color: #F9F4EB;
            color: #736357;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23736357' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .btn-primary {
            @apply bg-sage text-white px-4 py-2 rounded shadow hover:bg-opacity-90 transition-all duration-300 font-sans tracking-wide font-medium flex items-center justify-center;
        }
        .btn-secondary {
            @apply bg-slate text-white px-4 py-2 rounded shadow hover:bg-opacity-70 transition-all duration-300 font-sans tracking-wide font-medium flex items-center justify-center;
        }
        .btn-tertiary {
            @apply bg-white text-primary border border-primary/20 px-4 py-2 rounded shadow hover:bg-primary/5 transition-all duration-300 font-sans tracking-wide font-medium flex items-center justify-center;
        }
        .btn-danger {
            @apply bg-accent text-white px-4 py-2 rounded shadow hover:bg-opacity-90 transition-all duration-300 font-sans tracking-wide font-medium flex items-center justify-center;
        }
        .card {
            @apply bg-white shadow-md rounded-lg p-6 border border-primary/10;
        }
        .input-field {
            @apply w-full border-b-2 border-primary/20 bg-transparent py-2 px-1 focus:outline-none focus:border-sage transition-colors font-sans font-medium;
        }
        .custom-scroll::-webkit-scrollbar {
            height: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #ccc; 
            border-radius: 4px;
        }
        input[type="checkbox"] {
            accent-color: #8CA694;
            cursor: pointer;
            width: 1.1em;
            height: 1.1em;
        }
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }
        .animate-pop-in {
            animation: popIn 0.2s ease-out forwards;
        }
        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col font-sans font-medium" v-cloak>
    
    <!-- Header -->
    <header class="pt-8 pb-6 px-4 md:px-12 flex flex-col md:flex-row justify-between items-center border-b border-primary/10">
        <div class="mb-4 md:mb-0 text-center md:text-left">
            <h1 class="font-serif text-3xl md:text-4xl font-bold tracking-wider text-primary">å°é­çš„é‡çƒæ•¸æ“š</h1>
            <p class="text-sm tracking-widest text-primary/70 mt-1 uppercase font-medium">Baseball Logs Analytics</p>
            <!-- Storage Indicator -->
            <div class="mt-1 text-xs font-bold inline-flex items-center gap-1" :class="isFirebaseMode ? 'text-sage' : 'text-slate'">
                <span class="w-2 h-2 rounded-full" :class="isFirebaseMode ? 'bg-sage' : 'bg-slate'"></span>
                {{ isFirebaseMode ? 'é›²ç«¯åŒæ­¥ä¸­ (Cloud)' : 'æœ¬åœ°å„²å­˜æ¨¡å¼ (Local)' }}
            </div>
        </div>
        
        <div class="flex gap-4">
            <button @click="currentTab = 'batting'" :class="['px-6 py-2 rounded-full font-serif font-semibold transition-all', currentTab === 'batting' ? 'bg-sage text-white shadow-lg' : 'bg-white/50 hover:bg-white']">æ‰“æ“Šæ•¸æ“š</button>
            <button @click="currentTab = 'pitching'" :class="['px-6 py-2 rounded-full font-serif font-semibold transition-all', currentTab === 'pitching' ? 'bg-slate text-white shadow-lg' : 'bg-white/50 hover:bg-white']">æŠ•çƒæ•¸æ“š</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-4 md:p-8 max-w-7xl mx-auto w-full space-y-8">
        
        <!-- Dashboard Section -->
        <section class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
            <div class="card col-span-1 flex flex-col justify-center items-center text-center p-4">
                <h3 class="font-serif text-base md:text-lg text-primary/60 mb-2 font-bold">{{ currentTab === 'batting' ? 'å¹³å‡æ‰“æ“Šç‡ (AVG)' : 'é˜²ç¦¦ç‡ (ERA)' }}</h3>
                <p class="text-3xl md:text-5xl font-serif font-semibold text-sage">{{ mainStat }}</p>
                <div class="mt-2 text-xs md:text-sm text-primary/50">Cumulative Season Stats</div>
            </div>
             <div class="card col-span-1 flex flex-col justify-center items-center text-center p-4">
                <h3 class="font-serif text-base md:text-lg text-primary/60 mb-2 font-bold">{{ currentTab === 'batting' ? 'æ•´é«”æ”»æ“ŠæŒ‡æ•¸ (OPS)' : 'æ¯å±€è¢«ä¸Šå£˜ç‡ (WHIP)' }}</h3>
                <p class="text-3xl md:text-5xl font-serif font-semibold text-slate">{{ secondaryStat }}</p>
                <div class="mt-2 text-xs md:text-sm text-primary/50">Performance Metric</div>
            </div>

            <!-- Enhanced Chart Card -->
            <div class="card col-span-2 relative h-64 flex flex-col">
                <div class="flex justify-between items-center mb-2 z-10">
                    <h3 class="font-serif font-bold text-primary/70 text-sm">æ•¸æ“šåˆ†æ</h3>
                    <select v-model="chartMode" class="bg-primary/5 text-primary border-none rounded px-3 py-1 text-xs font-sans font-bold focus:ring-1 focus:ring-sage cursor-pointer hover:bg-primary/10 transition">
                        <option value="trend">ğŸ“‰ æ™‚é–“è¶¨å‹¢ (Trend)</option>
                        <option value="opponent">ğŸ†š ä¾å°æ‰‹ (By Opponent)</option>
                        <option value="game">ğŸ† ä¾è³½äº‹ (By Game)</option>
                    </select>
                </div>
                <div class="relative flex-grow w-full h-full min-h-0">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Tools Section -->
        <section class="flex flex-wrap justify-between items-end gap-4">
            <div class="flex gap-4 items-center flex-wrap">
                <button @click="showForm = true; isEditing = false; resetForm()" class="btn-primary flex items-center gap-2">
                    <span>âœ</span>
                    <span class="inline sm:hidden">æ–°å¢</span>
                    <span class="hidden sm:inline">æ–°å¢ç´€éŒ„</span>
                </button>
                <div class="relative group">
                    <label class="btn-secondary cursor-pointer flex items-center gap-2">
                        <span>âœ‰ï¸</span>
                        <span class="inline sm:hidden">åŒ¯å…¥</span>
                        <span class="hidden sm:inline">åŒ¯å…¥ (CSV/JSON)</span>
                        <input type="file" @change="handleFileUpload" accept=".csv, .xlsx, .xls, .json" class="hidden">
                    </label>
                </div>
                <button @click="exportData" class="btn-tertiary flex items-center gap-2" title="åŒ¯å‡º JSON å‚™ä»½æª”"> 
                    <span>â¤“</span>
                    <span class="inline sm:hidden">å‚™ä»½</span>
                    <span class="hidden sm:inline">åŒ¯å‡ºå‚™ä»½</span> 
                </button>
                <button @click="showHelp = true" class="btn-icon text-lg font-serif font-semibold" title="æŸ¥çœ‹æª”æ¡ˆæ ¼å¼èªªæ˜">?</button>
            </div>
            
            <div class="flex gap-2 items-center w-full md:w-auto">
                <button v-if="selectedIds.size > 0" @click="deleteSelected" class="btn-danger flex items-center gap-2 animate-pulse whitespace-nowrap">
                    <span>ğŸ—‘ï¸</span> <span class="hidden sm:inline">åˆªé™¤é¸å–</span> ({{ selectedIds.size }})
                </button>
                <div class="relative flex-grow md:flex-grow-0">
                    <input v-model="searchQuery" type="text" placeholder="æœå°‹..." class="bg-white px-4 py-2 rounded-full border border-primary/10 focus:outline-none focus:ring-1 focus:ring-sage w-full md:w-64 font-medium">
                </div>
            </div>
        </section>

        <!-- Data Table -->
        <section class="card overflow-hidden p-0">
            <div class="overflow-x-auto custom-scroll">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-primary/5 text-primary text-sm font-serif font-semibold uppercase tracking-wider">
                            <th class="p-4 w-12 text-center">
                                <input type="checkbox" :checked="isAllSelected" @change="toggleSelectAll" title="å…¨é¸">
                            </th>
                            <th class="p-4 whitespace-nowrap">æ—¥æœŸ</th>
                            <th class="p-4 whitespace-nowrap">æ¯”è³½åç¨±</th>
                            <th class="p-4 whitespace-nowrap">çƒå ´</th>
                            <th class="p-4 whitespace-nowrap">å°æ‰‹</th>
                            <th v-for="col in displayColumns" :key="col.key" class="p-4 whitespace-nowrap text-center cursor-pointer hover:bg-primary/10" @click="sortBy(col.key)">
                                {{ col.label }}
                            </th>
                            <th class="p-4 whitespace-nowrap text-right">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-primary/10 text-sm font-sans">
                        <tr v-for="(log, index) in filteredLogs" :key="log.id" class="hover:bg-primary/5 transition-colors" :class="{'bg-primary/5': selectedIds.has(log.id)}">
                            <td class="p-4 text-center">
                                <input type="checkbox" :checked="selectedIds.has(log.id)" @change="toggleSelect(log.id)">
                            </td>
                            <td class="p-4 whitespace-nowrap font-semibold">{{ log.date }}</td>
                            <td class="p-4 whitespace-nowrap">{{ log.gameName }}</td>
                            <td class="p-4 whitespace-nowrap text-primary/70">{{ log.stadium || '-' }}</td>
                            <td class="p-4 whitespace-nowrap">{{ log.opponent }}</td>
                            <td v-for="col in displayColumns" :key="col.key" class="p-4 whitespace-nowrap text-center">
                                {{ log[col.key] }}
                            </td>
                            <td class="p-4 whitespace-nowrap text-right space-x-2">
                                <button @click="editLog(log)" class="text-slate hover:text-slate/70 font-medium">ç·¨è¼¯</button>
                                <button @click="deleteLog(log.id)" class="text-accent hover:text-accent/70 font-medium">åˆªé™¤</button>
                            </td>
                        </tr>
                        <tr v-if="filteredLogs.length === 0">
                            <td :colspan="displayColumns.length + 6" class="p-12 text-center text-primary/40 italic font-serif">
                                å°šæœªæœ‰æ•¸æ“šï¼Œè«‹æ–°å¢ç´€éŒ„æˆ–åŒ¯å…¥è³‡æ–™ã€‚<br>
                                <span class="text-xs text-sage mt-2 block" v-if="isFirebaseMode">ç³»çµ±å·²é€£æ¥é›²ç«¯è³‡æ–™åº«ï¼Œè³‡æ–™å°‡è‡ªå‹•åŒæ­¥ã€‚</span>
                                <span class="text-xs text-slate mt-2 block" v-else>ç›®å‰ç‚ºæœ¬åœ°æ¨¡å¼ï¼Œè³‡æ–™å„²å­˜æ–¼ç€è¦½å™¨ä¸­ã€‚å»ºè­°å®šæœŸé»æ“Šã€ŒåŒ¯å‡ºå‚™ä»½ã€ä¿å­˜è³‡æ–™ã€‚</span>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot v-if="filteredLogs.length > 0" class="bg-primary/5 font-semibold text-primary">
                        <tr>
                            <td colspan="5" class="p-4 text-right font-serif">ç¸½è¨ˆ / å¹³å‡</td>
                            <td v-for="col in displayColumns" :key="col.key" class="p-4 text-center font-sans">
                                {{ calculateTotal(col.key) }}
                            </td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </section>
        
        <!-- Distribution Charts -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-8" v-if="logs.length > 0">
            <div class="card h-80">
                <h4 class="font-serif font-bold text-lg mb-4 text-center">{{ currentTab === 'batting' ? 'å®‰æ‰“é¡å‹åˆ†ä½ˆ' : 'å¥½å£çƒ/ä¸‰æŒ¯ä¿é€ä½”æ¯”' }}</h4>
                <div class="h-60 flex justify-center">
                    <canvas id="distChart1"></canvas>
                </div>
            </div>
            <div class="card h-80">
                 <h4 class="font-serif font-bold text-lg mb-4 text-center">{{ currentTab === 'batting' ? 'çµæœåˆ†ä½ˆ (ä¸Šå£˜ vs å‡ºå±€)' : 'æŠ•çƒçµæœåˆ†ä½ˆ' }}</h4>
                <div class="h-60 flex justify-center">
                    <canvas id="distChart2"></canvas>
                </div>
            </div>
        </section>

    </main>

    <!-- Modal Form (Same) -->
    <div v-if="showForm" class="fixed inset-0 bg-primary/40 backdrop-blur-sm flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto animate-pop-in">
            <div class="p-6 border-b border-primary/10 flex justify-between items-center">
                <h2 class="font-serif text-2xl font-semibold text-primary">{{ isEditing ? 'ç·¨è¼¯ç´€éŒ„' : 'æ–°å¢ç´€éŒ„' }} - {{ currentTab === 'batting' ? 'æ‰“æ“Š' : 'æŠ•çƒ' }}</h2>
                <button @click="showForm = false" class="text-2xl text-primary/50 hover:text-primary">&times;</button>
            </div>
            <form @submit.prevent="submitForm" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Common Fields -->
                <div class="md:col-span-2 grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-primary/60 mb-1">æ—¥æœŸ *</label>
                        <input v-model="formData.date" type="date" required class="input-field">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-primary/60 mb-1">æ¯”è³½åç¨±</label>
                        <input v-model="formData.gameName" type="text" placeholder="ä¾‹ï¼šä¾‹è¡Œè³½ G1" class="input-field">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-primary/60 mb-1">æ¯”è³½çƒå ´</label>
                        <input v-model="formData.stadium" type="text" placeholder="ä¾‹ï¼šè‡ºåŒ—å¤§å·¨è›‹" class="input-field">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-primary/60 mb-1">å°æ‰‹</label>
                        <input v-model="formData.opponent" type="text" placeholder="å°æ‰‹éšŠå" class="input-field">
                    </div>
                </div>
                <div class="md:col-span-2 border-t border-primary/10 my-2"></div>
                <template v-if="currentTab === 'batting'">
                    <div v-for="field in battingFields" :key="field.key">
                        <label class="block text-xs font-bold text-primary/60 mb-1">{{ field.label }}</label>
                        <input v-model.number="formData[field.key]" type="number" min="0" class="input-field bg-gray-50/50">
                    </div>
                </template>
                <template v-else>
                    <div v-for="field in pitchingFields" :key="field.key">
                        <label class="block text-xs font-bold text-primary/60 mb-1">
                            {{ field.label }} 
                            <span v-if="field.key === 'IP'" class="text-[10px] text-accent font-normal">(è¼¸å…¥ 5.1 ä»£è¡¨ 5å±€1/3)</span>
                        </label>
                        <input v-model.number="formData[field.key]" type="number" step="0.1" min="0" class="input-field bg-gray-50/50">
                    </div>
                </template>
                <div class="md:col-span-2 mt-4 flex gap-4">
                    <button type="submit" class="flex-1 btn-primary">{{ isEditing ? 'æ›´æ–°' : 'å„²å­˜' }}</button>
                    <button type="button" @click="showForm = false" class="flex-1 py-2 rounded text-primary hover:bg-primary/10 transition font-medium">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Help Modal (Updated for JSON) -->
    <div v-if="showHelp" class="fixed inset-0 bg-primary/40 backdrop-blur-sm flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col animate-pop-in">
            <div class="p-6 border-b border-primary/10 flex justify-between items-center flex-shrink-0">
                <h2 class="font-serif text-xl font-semibold text-primary">æª”æ¡ˆåŠŸèƒ½èªªæ˜</h2>
                <button @click="showHelp = false" class="text-2xl text-primary/50 hover:text-primary">&times;</button>
            </div>
            
            <div class="p-6 text-sm text-primary/80 modal-body space-y-4">
                <div class="bg-sage/10 p-4 rounded mb-4">
                    <h4 class="font-bold text-sage mb-2">è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h4>
                    <p class="mb-2"><strong>åŒ¯å‡ºå‚™ä»½ï¼š</strong> é»æ“Šã€ŒåŒ¯å‡ºå‚™ä»½ã€æŒ‰éˆ•ï¼Œç³»çµ±æœƒä¸‹è¼‰ä¸€å€‹ <code>.json</code> æª”æ¡ˆã€‚è«‹å¦¥å–„ä¿å­˜æ­¤æª”æ¡ˆï¼Œå®ƒæ˜¯æ‚¨æ‰€æœ‰ç´€éŒ„çš„å‚™ä»½ã€‚</p>
                    <p><strong>é‚„åŸå‚™ä»½ï¼š</strong> é»æ“Šã€ŒåŒ¯å…¥ã€æŒ‰éˆ•ä¸¦é¸æ“‡æ‚¨çš„ <code>.json</code> å‚™ä»½æª”ï¼Œå³å¯å°‡è³‡æ–™é‚„åŸã€‚</p>
                </div>

                <p>è‹¥ä½¿ç”¨ Excel (.xlsx) æˆ– CSV åŒ¯å…¥ï¼Œè«‹ç¢ºä¿ç¬¬ä¸€åˆ—åŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š</p>
                <div class="bg-primary/5 p-4 rounded">
                    <h4 class="font-bold text-sage mb-2">é€šç”¨æ¬„ä½ (å»ºè­°)</h4>
                    <p class="leading-relaxed">
                        â€¢ <strong>æ—¥æœŸ (Date)</strong><br>
                        â€¢ <strong>æ¯”è³½åç¨± (Game)</strong><br>
                        â€¢ <strong>æ¯”è³½çƒå ´ (Stadium)</strong><br>
                        â€¢ <strong>å°æ‰‹ (Opponent)</strong>
                    </p>
                </div>
                <!-- ... (Column tables same as before) ... -->
                 <div v-if="currentTab === 'batting'">
                    <h4 class="font-bold text-sage mb-2 mt-4">æ‰“æ“Šæ•¸æ“šæ¬„ä½</h4>
                    <table class="w-full text-left border-collapse">
                        <tr class="border-b border-primary/10"><th class="py-1">ä»£ç¢¼</th><th class="py-1">ä¸­æ–‡èªªæ˜</th></tr>
                        <tr><td class="py-1">PA</td><td>æ‰“å¸­</td></tr>
                        <tr><td class="py-1">AB</td><td>æ‰“æ•¸</td></tr>
                        <tr><td class="py-1">H</td><td>å®‰æ‰“ (ç¸½æ•¸)</td></tr>
                        <tr><td class="py-1">2B</td><td>äºŒå£˜æ‰“</td></tr>
                        <tr><td class="py-1">3B</td><td>ä¸‰å£˜æ‰“</td></tr>
                        <tr><td class="py-1">HR</td><td>å…¨å£˜æ‰“</td></tr>
                        <tr><td class="py-1">RBI</td><td>æ‰“é»</td></tr>
                        <tr><td class="py-1">BB</td><td>å››å£ä¿é€</td></tr>
                        <tr><td class="py-1">SO</td><td>ä¸‰æŒ¯</td></tr>
                        <tr><td class="py-1">SB</td><td>ç›œå£˜</td></tr>
                        <tr><td class="py-1">SF</td><td>é«˜é£›çŠ§ç‰²</td></tr>
                    </table>
                </div>
                <div v-if="currentTab === 'pitching'">
                    <h4 class="font-bold text-sage mb-2 mt-4">æŠ•çƒæ•¸æ“šæ¬„ä½</h4>
                    <table class="w-full text-left border-collapse">
                        <tr class="border-b border-primary/10"><th class="py-1">ä»£ç¢¼</th><th class="py-1">ä¸­æ–‡èªªæ˜</th></tr>
                        <tr><td class="py-1">IP</td><td>å±€æ•¸ (ä¾‹: 5.1)</td></tr>
                        <tr><td class="py-1">W</td><td>å‹æŠ• (1æˆ–0)</td></tr>
                        <tr><td class="py-1">L</td><td>æ•—æŠ• (1æˆ–0)</td></tr>
                        <tr><td class="py-1">H</td><td>è¢«å®‰æ‰“</td></tr>
                        <tr><td class="py-1">R</td><td>å¤±åˆ†</td></tr>
                        <tr><td class="py-1">ER</td><td>è²¬å¤±åˆ†</td></tr>
                        <tr><td class="py-1">BB</td><td>å››å£ä¿é€</td></tr>
                        <tr><td class="py-1">K</td><td>ä¸‰æŒ¯ (æˆ– SO)</td></tr>
                        <tr><td class="py-1">HR</td><td>è¢«å…¨å£˜æ‰“</td></tr>
                    </table>
                </div>
            </div>
            <div class="p-4 border-t border-primary/10 text-center flex-shrink-0">
                <button @click="showHelp = false" class="btn-primary w-full">æˆ‘çŸ¥é“äº†</button>
            </div>
        </div>
    </div>

    <!-- Custom Dialog Modal -->
    <div v-if="dialog.show" class="fixed inset-0 bg-primary/40 backdrop-blur-sm flex justify-center items-center z-[60] p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm flex flex-col overflow-hidden animate-pop-in">
            <div class="p-6 text-center">
                <div class="text-4xl mb-4">{{ dialog.icon }}</div>
                <h3 class="font-serif text-xl font-semibold text-primary mb-2">{{ dialog.title }}</h3>
                <p class="text-primary/70 text-sm leading-relaxed">{{ dialog.message }}</p>
            </div>
            <div class="flex border-t border-primary/10">
                <button v-if="dialog.isConfirm" @click="dialog.show = false" class="flex-1 py-3 text-primary/60 hover:bg-primary/5 transition font-medium">å–æ¶ˆ</button>
                <div v-if="dialog.isConfirm" class="w-px bg-primary/10"></div>
                <button @click="handleDialogConfirm" :class="['flex-1 py-3 text-white transition font-medium', dialog.isConfirm ? 'bg-accent hover:bg-accent/90' : 'bg-sage hover:bg-sage/90']">
                    {{ dialog.confirmText || 'ç¢ºå®š' }}
                </button>
            </div>
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, writeBatch } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // Check for Firebase Config
            let isFirebaseAvailable = false;
            let db = null;
            let auth = null;
            let appId = 'default-app-id';

            try {
                if (typeof __firebase_config !== 'undefined') {
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    isFirebaseAvailable = true;
                }
            } catch (e) {
                console.warn("Firebase Init Skipped: Running in Local Mode");
            }

            // Global State
            const isFirebaseMode = ref(isFirebaseAvailable);
            const user = ref(null);
            
            // Register DataLabels
            if (typeof ChartDataLabels !== 'undefined') {
                Chart.register(ChartDataLabels);
            }

            // App State
            const currentTab = ref('batting');
            const showForm = ref(false);
            const showHelp = ref(false);
            const isEditing = ref(false);
            const searchQuery = ref('');
            const logs = ref([]);
            const selectedIds = ref(new Set());
            const chartMode = ref('trend');
            
            // Dialog
            const dialog = ref({ show: false, title: '', message: '', icon: '', isConfirm: false, confirmText: '', onConfirm: null });

            // Chart Refs
            let trendChartInstance = null;
            let distChart1Instance = null;
            let distChart2Instance = null;

            // Form Data Structure
            const defaultFormData = {
                date: new Date().toISOString().split('T')[0], gameName: '', stadium: '', opponent: '',
                // Batting
                PA: 0, AB: 0, H: 0, B2: 0, B3: 0, HR: 0, RBI: 0, BB: 0, SO: 0, SF: 0, SB: 0,
                // Pitching
                IP: 0, H_p: 0, R: 0, ER: 0, BB_p: 0, SO_p: 0, HR_p: 0, W: 0, L: 0, SV: 0
            };
            const formData = ref({ ...defaultFormData });

            // Fields (Same as before)
            const battingFields = [
                { key: 'PA', label: 'æ‰“å¸­ (PA)' }, { key: 'AB', label: 'æ‰“æ•¸ (AB)' },
                { key: 'H', label: 'å®‰æ‰“ (H)' }, { key: 'B2', label: 'äºŒå£˜æ‰“ (2B)' },
                { key: 'B3', label: 'ä¸‰å£˜æ‰“ (3B)' }, { key: 'HR', label: 'å…¨å£˜æ‰“ (HR)' },
                { key: 'RBI', label: 'æ‰“é» (RBI)' }, { key: 'BB', label: 'å››å£ (BB)' },
                { key: 'SO', label: 'ä¸‰æŒ¯ (SO)' }, { key: 'SB', label: 'ç›œå£˜ (SB)' },
                { key: 'SF', label: 'é«˜é£›çŠ§ç‰² (SF)' }
            ];
            const pitchingFields = [
                { key: 'W', label: 'å‹ (W)' }, { key: 'L', label: 'æ•— (L)' },
                { key: 'IP', label: 'å±€æ•¸ (IP)' }, { key: 'H_p', label: 'è¢«å®‰æ‰“ (H)' },
                { key: 'R', label: 'å¤±åˆ† (R)' }, { key: 'ER', label: 'è²¬å¤± (ER)' },
                { key: 'BB_p', label: 'å››å£ (BB)' }, { key: 'SO_p', label: 'ä¸‰æŒ¯ (K)' },
                { key: 'HR_p', label: 'è¢«å…¨å£˜æ‰“ (HR)' }
            ];

            // Computed Properties (Same as before)
            const displayColumns = computed(() => {
                if (currentTab.value === 'batting') return [{key:'AB',label:'AB'},{key:'H',label:'H'},{key:'HR',label:'HR'},{key:'RBI',label:'RBI'},{key:'AVG',label:'AVG'},{key:'OPS',label:'OPS'}];
                return [{key:'IP',label:'IP'},{key:'H_p',label:'H'},{key:'ER',label:'ER'},{key:'SO_p',label:'K'},{key:'BB_p',label:'BB'},{key:'ERA',label:'ERA'},{key:'WHIP',label:'WHIP'}];
            });

            const filteredLogs = computed(() => {
                let data = logs.value.filter(l => l.type === currentTab.value);
                if (searchQuery.value) {
                    const q = searchQuery.value.toLowerCase();
                    data = data.filter(l => l.opponent?.toLowerCase().includes(q) || l.gameName?.toLowerCase().includes(q) || l.stadium?.toLowerCase().includes(q));
                }
                return data.map(log => ({ ...log, ...calculateStats(log) })).sort((a, b) => new Date(b.date) - new Date(a.date));
            });

            const isAllSelected = computed(() => filteredLogs.value.length > 0 && filteredLogs.value.every(log => selectedIds.value.has(log.id)));

            const mainStat = computed(() => {
                const data = filteredLogs.value;
                if (data.length === 0) return '---';
                if (currentTab.value === 'batting') {
                    const h = data.reduce((s, i) => s + (i.H || 0), 0);
                    const ab = data.reduce((s, i) => s + (i.AB || 0), 0);
                    return ab === 0 ? '.000' : (h / ab).toFixed(3).replace(/^0+/, '');
                } else {
                    const er = data.reduce((s, i) => s + (i.ER || 0), 0);
                    const outs = data.reduce((s, i) => s + convertIPtoOuts(i.IP), 0);
                    return outs === 0 ? '0.00' : (er * 9 / (outs/3)).toFixed(2);
                }
            });

            const secondaryStat = computed(() => {
                const data = filteredLogs.value;
                if (data.length === 0) return '---';
                if (currentTab.value === 'batting') {
                    const ab = data.reduce((s, i) => s + (i.AB || 0), 0);
                    const h = data.reduce((s, i) => s + (i.H || 0), 0);
                    const bb = data.reduce((s, i) => s + (i.BB || 0), 0);
                    const pa = data.reduce((s, i) => s + (i.PA || 0), 0);
                    const tb = data.reduce((s, i) => s + (i.H + (i.B2||0) + 2*(i.B3||0) + 3*(i.HR||0)), 0);
                    const obp = pa === 0 ? 0 : (h + bb) / pa;
                    const slg = ab === 0 ? 0 : tb / ab;
                    return (obp + slg).toFixed(3).replace(/^0+/, '');
                } else {
                    const outs = data.reduce((s, i) => s + convertIPtoOuts(i.IP), 0);
                    const wh = data.reduce((s, i) => s + (i.BB_p || 0) + (i.H_p || 0), 0);
                    return outs === 0 ? '0.00' : (wh / (outs/3)).toFixed(2);
                }
            });

            // Init
            onMounted(() => {
                if (isFirebaseAvailable) {
                    const initAuth = async () => {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (err) { console.error("Auth failed", err); }
                    };
                    initAuth();
                    onAuthStateChanged(auth, (u) => {
                        user.value = u;
                        if (u) {
                            const q = collection(db, 'artifacts', appId, 'public', 'data', 'baseball_logs');
                            onSnapshot(q, (snapshot) => {
                                logs.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            });
                        }
                    });
                } else {
                    const saved = localStorage.getItem('baseball_logs');
                    if (saved) logs.value = JSON.parse(saved);
                    else {
                        logs.value = [
                            { id: 1, type: 'batting', date: '2023-10-01', gameName: 'ç¯„ä¾‹è³½', stadium: 'å°åŒ—', opponent: 'æ¸¬è©¦éšŠ', PA: 4, AB: 3, H: 1, B2: 0, B3: 0, HR: 0, RBI: 0, BB: 1, SO: 0, SF: 0, SB: 0 }
                        ];
                    }
                }
                renderCharts();
            });

            // Export Data Function
            function exportData() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(logs.value));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "baseball_data_backup.json");
                document.body.appendChild(downloadAnchorNode); // required for firefox
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }

            // Updated File Upload Handler
            function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    let newLogs = [];
                    
                    // Handle JSON
                    if (file.name.endsWith('.json')) {
                        try {
                            const json = JSON.parse(e.target.result);
                            if (Array.isArray(json)) {
                                newLogs = json;
                            } else {
                                showAlert('éŒ¯èª¤', 'JSON æ ¼å¼ä¸æ­£ç¢º');
                                return;
                            }
                        } catch(err) {
                            showAlert('éŒ¯èª¤', 'ç„¡æ³•è§£æ JSON æª”æ¡ˆ');
                            return;
                        }
                    } 
                    // Handle Excel/CSV
                    else {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet, { defval: 0 });
                        if(!json.length) { showAlert('éŒ¯èª¤','ç„¡è³‡æ–™'); return; }
                        
                        newLogs = json.map(row => {
                            return { 
                                type: currentTab.value, 
                                date: row['æ—¥æœŸ'] || row['Date'] || new Date().toISOString().split('T')[0],
                                gameName: row['æ¯”è³½åç¨±'] || row['Game'] || 'åŒ¯å…¥',
                                stadium: row['çƒå ´'] || row['Stadium'] || '',
                                opponent: row['å°æ‰‹'] || row['Opponent'] || '',
                                PA: row['PA']||0, AB: row['AB']||0, H: row['H']||0, B2: row['2B']||0, B3: row['3B']||0, HR: row['HR']||0, RBI: row['RBI']||0, BB: row['BB']||0, SO: row['SO']||0, SF: row['SF']||0, SB: row['SB']||0,
                                IP: row['IP']||0, W: row['W']||0, L: row['L']||0, SV: row['SV']||0, H_p: row['H']||0, R: row['R']||0, ER: row['ER']||0, BB_p: row['BB']||0, SO_p: row['SO']||0, HR_p: row['HR']||0
                            }; 
                        });
                    }

                    if(isFirebaseAvailable) {
                        const batch = writeBatch(db);
                        newLogs.forEach(l => {
                            // Ensure clean data for Firestore
                            const { id, ...cleanData } = l; 
                            batch.set(doc(collection(db,'artifacts',appId,'public','data','baseball_logs')), cleanData);
                        });
                        await batch.commit();
                    } else {
                        // Local Mode: Merge strategy (Append new logs)
                        // If JSON import often implies restore, we might want to replace or merge. 
                        // Here we append new items with new IDs.
                        newLogs.forEach(l => { 
                            // If it's a JSON restore, it might already have IDs, but best to regenerate for local consistency
                            l.id = Date.now() + Math.random(); 
                            logs.value.push(l); 
                        });
                        localStorage.setItem('baseball_logs', JSON.stringify(logs.value));
                    }
                    showAlert('æˆåŠŸ', `å·²åŒ¯å…¥/é‚„åŸ ${newLogs.length} ç­†è³‡æ–™`);
                    event.target.value = '';
                };
                
                if (file.name.endsWith('.json')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            }

            // CRUD Operations (Same as before)
            async function submitForm() {
                const payload = { ...formData.value, type: currentTab.value };
                if (isFirebaseAvailable && user.value) {
                    try {
                        const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'baseball_logs');
                        if (isEditing.value && payload.id) {
                            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'baseball_logs', payload.id);
                            const { id, ...data } = payload;
                            await updateDoc(docRef, data);
                        } else {
                            delete payload.id;
                            await addDoc(colRef, payload);
                        }
                    } catch (e) { showAlert('éŒ¯èª¤', 'é›²ç«¯å„²å­˜å¤±æ•—'); }
                } else {
                    if (isEditing.value) {
                        const idx = logs.value.findIndex(l => l.id === payload.id);
                        if (idx !== -1) logs.value[idx] = payload;
                    } else {
                        payload.id = Date.now();
                        logs.value.push(payload);
                    }
                    localStorage.setItem('baseball_logs', JSON.stringify(logs.value));
                }
                showForm.value = false;
                resetForm();
            }

            async function deleteLog(id) {
                showConfirm('åˆªé™¤ç¢ºèª', 'ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ', async () => {
                    if (isFirebaseAvailable && user.value) {
                        try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'baseball_logs', id)); } catch(e){}
                    } else {
                        logs.value = logs.value.filter(l => l.id !== id);
                        localStorage.setItem('baseball_logs', JSON.stringify(logs.value));
                    }
                    if(selectedIds.value.has(id)) selectedIds.value.delete(id);
                });
            }

            async function deleteSelected() {
                showConfirm('åˆªé™¤ç¢ºèª', `åˆªé™¤ ${selectedIds.value.size} ç­†ï¼Ÿ`, async () => {
                    if (isFirebaseAvailable && user.value) {
                        const batch = writeBatch(db);
                        selectedIds.value.forEach(id => {
                            batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'baseball_logs', id));
                        });
                        await batch.commit();
                    } else {
                        logs.value = logs.value.filter(l => !selectedIds.value.has(l.id));
                        localStorage.setItem('baseball_logs', JSON.stringify(logs.value));
                    }
                    selectedIds.value.clear();
                });
            }

            // Utils (Same as before)
            function convertIPtoOuts(ip) { const s = String(ip).split('.'); return (parseInt(s[0])*3) + (s[1]?parseInt(s[1]):0); }
            function convertOutsToIP(outs) { return (outs % 3 === 0) ? Math.floor(outs/3) : parseFloat(`${Math.floor(outs/3)}.${outs%3}`); }
            function calculateStats(log) {
                if (log.type === 'batting') {
                    const avg = log.AB ? log.H / log.AB : 0;
                    const single = log.H - (log.B2||0) - (log.B3||0) - (log.HR||0);
                    const tb = single + 2*(log.B2||0) + 3*(log.B3||0) + 4*(log.HR||0);
                    const slg = log.AB ? tb / log.AB : 0;
                    const obp = log.PA ? (log.H + log.BB) / log.PA : 0;
                    return { AVG: avg.toFixed(3).replace(/^0+/, ''), OPS: (obp+slg).toFixed(3).replace(/^0+/, '') };
                } else {
                    const outs = convertIPtoOuts(log.IP);
                    const era = outs ? (log.ER*9)/(outs/3) : 0;
                    const whip = outs ? (log.BB_p+log.H_p)/(outs/3) : 0;
                    return { ERA: era.toFixed(2), WHIP: whip.toFixed(2) };
                }
            }
            function calculateTotal(key) {
                if (['AVG','OPS','ERA','WHIP'].includes(key)) return '---';
                let total = filteredLogs.value.reduce((s, i) => s + (Number(i[key])||0), 0);
                return key === 'IP' ? convertOutsToIP(filteredLogs.value.reduce((s,i)=>s+convertIPtoOuts(i.IP),0)) : total;
            }
            function calculateGroupStat(groupLogs) {
                if (currentTab.value === 'batting') {
                    const h = groupLogs.reduce((s,l)=>s+(l.H||0),0);
                    const ab = groupLogs.reduce((s,l)=>s+(l.AB||0),0);
                    return ab ? h/ab : 0;
                } else {
                    const er = groupLogs.reduce((s,l)=>s+(l.ER||0),0);
                    const outs = groupLogs.reduce((s,l)=>s+convertIPtoOuts(l.IP),0);
                    return outs ? er*9/(outs/3) : 0;
                }
            }
            function sortBy(k){ logs.value.sort((a,b)=>(b[k]||0)-(a[k]||0)); }
            function editLog(l){ formData.value={...l}; currentTab.value=l.type; isEditing.value=true; showForm.value=true; }
            function resetForm(){ formData.value={...defaultFormData, date: new Date().toISOString().split('T')[0]}; }
            function toggleSelectAll(e){ if(e.target.checked) filteredLogs.value.forEach(l=>selectedIds.value.add(l.id)); else selectedIds.value.forEach(l=>selectedIds.value.delete(l.id)); }
            function toggleSelect(id){ if(selectedIds.value.has(id)) selectedIds.value.delete(id); else selectedIds.value.add(id); }
            function showConfirm(t,m,cb){ dialog.value={show:true,title:t,message:m,icon:'ğŸ—‘ï¸',isConfirm:true,confirmText:'ç¢ºèª',onConfirm:cb}; }
            function showAlert(t,m,e=false){ dialog.value={show:true,title:t,message:m,icon:e?'âŒ':'âœ…',isConfirm:false,confirmText:'å¥½',onConfirm:null}; }
            function handleDialogConfirm(){ if(dialog.value.onConfirm) dialog.value.onConfirm(); dialog.value.show=false; }

            // Chart Rendering
            function renderCharts() {
                nextTick(() => {
                    const ctxTrend = document.getElementById('trendChart');
                    const ctxDist1 = document.getElementById('distChart1');
                    const ctxDist2 = document.getElementById('distChart2');
                    
                    if (trendChartInstance) { trendChartInstance.destroy(); trendChartInstance = null; }
                    if (distChart1Instance) { distChart1Instance.destroy(); distChart1Instance = null; }
                    if (distChart2Instance) { distChart2Instance.destroy(); distChart2Instance = null; }

                    if (!ctxTrend) return;

                    const primaryColor = '#8CA694';
                    const secondaryColor = '#88A6B0';

                    let labels, mainData, chartType;

                    if (chartMode.value === 'trend') {
                         const data = filteredLogs.value.slice().reverse();
                         labels = data.map(l => l.date.slice(5));
                         mainData = currentTab.value === 'batting' ? data.map(l=>calculateStats(l).AVG) : data.map(l=>calculateStats(l).ERA);
                         chartType = 'line';
                    } else {
                        const key = chartMode.value === 'game' ? 'gameName' : 'opponent';
                        const groups = {};
                        filteredLogs.value.forEach(l => { const k=l[key]||'æœªçŸ¥'; if(!groups[k]) groups[k]=[]; groups[k].push(l); });
                        labels = Object.keys(groups);
                        mainData = labels.map(k => calculateGroupStat(groups[k]));
                        chartType = 'bar';
                    }
                    
                    trendChartInstance = new Chart(ctxTrend, {
                        type: chartType,
                        data: {
                            labels: labels,
                            datasets: [{ label: currentTab.value==='batting'?'AVG':'ERA', data: mainData, borderColor: '#8CA694', backgroundColor: chartType==='line'?'#8CA69433':'#8CA694', tension: 0.3, fill: chartType==='line' }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, datalabels: {display:false} }, scales: { y: {beginAtZero: chartType==='bar'} } }
                    });

                    if (ctxDist1 && ctxDist2) {
                        const d = filteredLogs.value;
                        let d1, l1, d2, l2;
                        if(currentTab.value==='batting') {
                            const h=d.reduce((s,i)=>s+(i.H||0),0), bb=d.reduce((s,i)=>s+(i.BB||0),0), so=d.reduce((s,i)=>s+(i.SO||0),0);
                            l1=['å®‰æ‰“','ä¿é€','ä¸‰æŒ¯','å…¶ä»–']; d1=[h,bb,so,Math.max(0, d.reduce((s,i)=>s+(i.PA||0),0)-h-bb-so)];
                            const h1=d.reduce((s,i)=>s+((i.H||0)-(i.B2||0)-(i.B3||0)-(i.HR||0)),0);
                            l2=['ä¸€å®‰','äºŒå®‰','ä¸‰å®‰','å…¨å£˜æ‰“']; d2=[h1, d.reduce((s,i)=>s+(i.B2||0),0), d.reduce((s,i)=>s+(i.B3||0),0), d.reduce((s,i)=>s+(i.HR||0),0)];
                        } else {
                            l1=['ä¸‰æŒ¯','ä¿é€','å…¶ä»–']; d1=[d.reduce((s,i)=>s+(i.SO_p||0),0), d.reduce((s,i)=>s+(i.BB_p||0),0), Math.max(0, d.reduce((s,i)=>s+convertIPtoOuts(i.IP),0)-d.reduce((s,i)=>s+(i.SO_p||0),0))];
                            l2=['å‹','æ•—','æ•‘æ´']; d2=[d.reduce((s,i)=>s+(i.W||0),0), d.reduce((s,i)=>s+(i.L||0),0), d.reduce((s,i)=>s+(i.SV||0),0)];
                        }

                        distChart1Instance = new Chart(ctxDist1, { type: 'doughnut', data: { labels: l1, datasets: [{ data: d1, backgroundColor: ['#8CA694','#88A6B0','#D97C6E','#F2E8D5'] }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{ datalabels:{ color:'#fff', font:{weight:'bold'}, formatter:(v,c)=>{let s=0;c.chart.data.datasets[0].data.map(n=>s+=n);return s?(v*100/s).toFixed(1)+'%':'';} } } } });
                        distChart2Instance = new Chart(ctxDist2, { type: 'bar', data: { labels: l2, datasets: [{ label:'æ•¸é‡', data: d2, backgroundColor:'#736357' }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{ datalabels:{display:false} } } });
                    }
                });
            }

            watch([currentTab, chartMode, logs], () => { renderCharts(); }, { deep: true });

            return {
                currentTab, showForm, showHelp, isEditing, formData, searchQuery, logs, selectedIds, chartMode,
                battingFields, pitchingFields, displayColumns, filteredLogs, mainStat, secondaryStat, isFirebaseMode,
                submitForm, editLog, deleteLog, deleteSelected, resetForm, handleFileUpload, calculateTotal, sortBy,
                dialog, handleDialogConfirm, exportData
            };
        }
    }).mount('#app');
</script>

</body>
</html>
