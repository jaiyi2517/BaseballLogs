<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°é­çš„é‡çƒæ•¸æ“š</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@600;700;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        retroPaper: '#F9F4EB',  /* æ›´æ–°ï¼šæ›´æ˜äº®çš„å¾©å¤ç±³ç™½ */
                        retroText: '#736357',   /* æ·±è¤ç° (æ–‡å­—) */
                        retroGreen: '#8CA694',  /* é¼ å°¾è‰ç¶  (ä¸»è‰²) */
                        retroBlue: '#88A6B0',   /* ç°è— (æ¬¡è‰²) */
                        retroWhite: '#FFFFFF',  /* ç´”ç™½ (å¡ç‰‡) */
                        retroAccent: '#D97C6E'  /* å¼·èª¿è‰² (ç´…) */
                    },
                    fontFamily: {
                        serif: ['"Noto Serif TC"', 'serif'],
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    },
                    boxShadow: {
                        'paper': '3px 3px 8px rgba(115, 99, 87, 0.15)',
                        'leather': '0 2px 0 rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.2)'
                    },
                    backgroundImage: {
                        // ç¶²æ ¼ç´‹ç†ç–ŠåŠ  (é€æ˜åº¦èª¿æ•´ç‚º 0.05ï¼Œéå¸¸æ¸…æ·¡)
                        'grid-pattern': 'linear-gradient(rgba(115, 99, 87, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(115, 99, 87, 0.05) 1px, transparent 1px)'
                    }
                }
            }
        }
    </script>

    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Chart.js & Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <!-- SheetJS (XLSX) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style type="text/tailwindcss">
        /* é é¢èƒŒæ™¯ï¼šæ›´æ–°å¾Œçš„åº•è‰² + ç¶²æ ¼ */
        body {
            background-color: #F9F4EB;
            background-image: theme('backgroundImage.grid-pattern');
            background-size: 20px 20px;
            color: #736357;
        }

        /* (å·²ç§»é™¤å·¦å´è£è¨‚ç·šè£é£¾) */

        /* ----- æŒ‰éˆ•è¨­è¨ˆ ----- */

        /* çš®é©æ¨™ç±¤é¢¨æ ¼ (å¯¦å¿ƒ) */
        .btn-leather {
            @apply text-white px-5 py-2 rounded-sm shadow-leather transition-all duration-200 font-serif font-bold tracking-wide flex items-center justify-center relative active:translate-y-[1px] active:shadow-none;
        }
        /* ç¸«ç·šæ•ˆæœ */
        .btn-leather::after {
            content: '';
            position: absolute;
            top: 3px; left: 3px; right: 3px; bottom: 3px;
            border: 1px dashed rgba(255,255,255,0.5);
            border-radius: 2px;
            pointer-events: none;
        }

        .btn-primary {
            @apply btn-leather bg-retroGreen hover:bg-[#7A9482];
        }
        
        .btn-secondary {
            @apply btn-leather bg-retroBlue hover:bg-[#76949E];
        }

        .btn-danger {
            @apply btn-leather bg-retroAccent hover:bg-[#C06A5C];
        }

        /* æ‰‹ç¹ªæ¡†ç·šé¢¨æ ¼ (é€æ˜) */
        .btn-sketch {
            @apply bg-retroWhite/50 text-retroText border-2 border-retroText/40 px-4 py-2 rounded-sm hover:bg-retroWhite hover:border-retroText transition-all duration-300 font-sans font-bold flex items-center justify-center backdrop-blur-sm;
            /* è®“é‚Šæ¡†çœ‹èµ·ä¾†æœ‰é»æ‰‹ç¹ªçš„ä¸è¦å‰‡æ„Ÿ */
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
        }

        /* ----- å¡ç‰‡è¨­è¨ˆ ----- */

        /* ä¾¿æ¢ç´™/å‰ªè²¼ç°¿é¢¨æ ¼ */
        .card {
            @apply bg-retroWhite shadow-paper p-6 relative transition-transform duration-300;
            border: 1px solid rgba(115, 99, 87, 0.1);
            /* å¾®å¦™çš„åœ“è§’ */
            border-radius: 2px; 
        }
        
        /* é ‚éƒ¨è† å¸¶è£é£¾ */
        .card-tape::before {
            content: "";
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%) rotate(-1deg);
            width: 100px;
            height: 24px;
            background-color: rgba(255, 255, 255, 0.4);
            border-left: 1px solid rgba(0,0,0,0.05);
            border-right: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            z-index: 1;
        }

        /* è¼¸å…¥æ¡†ï¼šæ‰‹å¯«ç·šæ¢ */
        .input-field {
            @apply w-full border-b-2 border-retroText/20 bg-transparent py-2 px-1 focus:outline-none focus:border-retroGreen text-retroText font-serif font-bold transition-colors placeholder-retroText/40;
        }

        /* æ»¾å‹•æ¢ (å¾©å¤æ£•) */
        .custom-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(115, 99, 87, 0.05); }
        .custom-scroll::-webkit-scrollbar-thumb { background: #BCAAA4; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #8D6E63; }

        .modal-body {
            @apply flex-1 overflow-y-auto custom-scroll min-h-0;
        }

        input[type="checkbox"] {
            accent-color: #8CA694;
            cursor: pointer;
            width: 1.1em;
            height: 1.1em;
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }
        .animate-pop-in {
            animation: popIn 0.2s ease-out forwards;
        }
        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col font-sans font-medium" v-cloak>
    
    <!-- Header -->
    <header class="pt-10 pb-8 px-6 md:px-16 flex flex-col md:flex-row justify-between items-center relative">
        <div class="mb-6 md:mb-0 text-center md:text-left">
            <h1 class="font-serif text-4xl md:text-5xl font-black tracking-wider text-retroText relative z-10">å°é­çš„é‡çƒæ•¸æ“š</h1>
            <div class="relative inline-block mt-2">
                <!-- æ¨™é¡Œè£é£¾åº•ç·šï¼šç¾åœ¨ä½æ–¼å‰¯æ¨™é¡Œå®¹å™¨å…§ï¼Œå¯¬åº¦æœƒè·Ÿéš¨æ–‡å­— -->
                <div class="absolute bottom-1 left-0 right-0 h-3 bg-retroGreen/20 -skew-x-12 transform"></div>
                <p class="text-sm tracking-[0.2em] text-retroText/60 uppercase font-bold font-sans relative z-10">Baseball Logs Analytics</p>
            </div>
        </div>
        
        <div class="flex gap-4">
            <button @click="currentTab = 'batting'" :class="['px-6 py-2 rounded-sm font-serif font-bold transition-all border-2 relative overflow-hidden', currentTab === 'batting' ? 'bg-retroGreen text-white border-retroGreen shadow-md' : 'text-retroText border-retroText/20 bg-retroWhite/50 hover:bg-retroWhite']">
                <span class="relative z-10">æ‰“æ“Šæ•¸æ“š</span>
            </button>
            <button @click="currentTab = 'pitching'" :class="['px-6 py-2 rounded-sm font-serif font-bold transition-all border-2 relative overflow-hidden', currentTab === 'pitching' ? 'bg-retroBlue text-white border-retroBlue shadow-md' : 'text-retroText border-retroText/20 bg-retroWhite/50 hover:bg-retroWhite']">
                <span class="relative z-10">æŠ•çƒæ•¸æ“š</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-4 md:px-12 max-w-7xl mx-auto w-full space-y-10">
        
        <!-- Dashboard Section -->
        <section class="grid grid-cols-2 md:grid-cols-4 gap-6">
            <!-- Card: Season Stats -->
            <div class="card card-tape col-span-1 flex flex-col justify-center items-center text-center rotate-[-1deg]">
                <h3 class="font-serif text-lg text-retroText/60 mb-2 font-bold">{{ currentTab === 'batting' ? 'å¹³å‡æ‰“æ“Šç‡ (AVG)' : 'é˜²ç¦¦ç‡ (ERA)' }}</h3>
                <p class="text-4xl md:text-5xl font-serif font-black text-retroGreen drop-shadow-sm">{{ mainStat }}</p>
                <div class="mt-2 text-xs md:text-sm text-retroText/40 font-bold border-t-2 border-retroText/10 pt-1 w-full max-w-[80%]">SEASON STATS</div>
            </div>
            <!-- Card: Advanced Stats -->
             <div class="card card-tape col-span-1 flex flex-col justify-center items-center text-center rotate-[1deg]">
                <h3 class="font-serif text-lg text-retroText/60 mb-2 font-bold">{{ currentTab === 'batting' ? 'æ•´é«”æ”»æ“ŠæŒ‡æ•¸ (OPS)' : 'æ¯å±€è¢«ä¸Šå£˜ç‡ (WHIP)' }}</h3>
                <p class="text-4xl md:text-5xl font-serif font-black text-retroBlue drop-shadow-sm">{{ secondaryStat }}</p>
                <div class="mt-2 text-xs md:text-sm text-retroText/40 font-bold border-t-2 border-retroText/10 pt-1 w-full max-w-[80%]">ADVANCED</div>
            </div>

            <!-- Enhanced Chart Card -->
            <div class="card col-span-2 relative h-72 flex flex-col border-2 border-retroText/10 bg-retroWhite/80">
                <!-- åƒåœ–é‡˜ä¸€æ¨£å›ºå®šä½ -->
                <div class="absolute -top-3 -right-3 text-2xl text-retroText/30 transform rotate-355">ğŸ“Œ</div>
            

                <div class="flex justify-between items-center mb-4 z-10 px-2">
                    <h3 class="font-serif font-black text-retroText text-lg flex items-center gap-2">
                        <span class="w-2 h-6 bg-retroGreen rounded-sm"></span> æ•¸æ“šåˆ†æ
                    </h3>
                    <select v-model="chartMode" class="bg-retroPaper text-retroText border-2 border-retroText/20 rounded-sm px-3 py-1 text-xs font-bold focus:border-retroGreen cursor-pointer hover:bg-white transition">
                        <option value="trend">ğŸ“‰ æ™‚é–“è¶¨å‹¢</option>
                        <option value="opponent">ğŸ†š ä¾å°æ‰‹</option>
                        <option value="game">ğŸ† ä¾è³½äº‹</option>
                    </select>
                </div>
                <div class="relative flex-grow w-full h-full min-h-0 bg-white border border-retroText/5 rounded-sm p-2">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Tools Section -->
        <section class="flex flex-wrap justify-between items-end gap-6 border-b-2 border-retroText/10 pb-6 border-dashed">
            <div class="flex gap-4 items-center">
                <button @click="showForm = true; isEditing = false; resetForm()" class="btn-primary flex items-center gap-2">
                    <span class="text-lg">âœï¸</span>
                    <span class="inline sm:hidden">æ–°å¢</span>
                    <span class="hidden sm:inline">æ–°å¢ç´€éŒ„</span>
                </button>
                <div class="relative group">
                    <label class="btn-secondary cursor-pointer flex items-center gap-2">
                        <span class="text-lg">ğŸ“¥</span>
                        <span class="inline sm:hidden">åŒ¯å…¥</span>
                        <span class="hidden sm:inline">åŒ¯å…¥ (CSV/XLSX)</span>
                        <input type="file" @change="handleFileUpload" accept=".csv, .xlsx, .xls, .json" class="hidden">
                    </label>
                </div>
            </div>
            
            <div class="flex gap-3 items-center w-full md:w-auto">
                <button v-if="selectedIds.size > 0" @click="deleteSelected" class="btn-danger flex items-center gap-2 animate-pulse whitespace-nowrap">
                    <span>ğŸ—‘ï¸</span> <span class="hidden sm:inline">åˆªé™¤é¸å–</span> ({{ selectedIds.size }})
                </button>
                <div class="relative flex-grow md:flex-grow-0">
                    <input v-model="searchQuery" type="text" placeholder="ğŸ” æœå°‹ç´€éŒ„..." class="bg-retroWhite border-2 border-retroText/20 px-4 py-2 rounded-sm focus:outline-none focus:border-retroGreen w-full md:w-64 font-bold text-retroText placeholder-retroText/40 shadow-inner">
                </div>
            </div>
        </section>

        <!-- Data Table -->
        <section class="card p-0 rounded-sm border-2 border-retroText/10 overflow-hidden bg-retroWhite">
            <div class="overflow-x-auto custom-scroll">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-retroText/5 text-retroText text-sm font-serif font-black uppercase tracking-wider border-b-2 border-retroText/10 border-dashed">
                            <th class="p-4 w-12 text-center bg-retroPaper/50">
                                <input type="checkbox" :checked="isAllSelected" @change="toggleSelectAll" title="å…¨é¸">
                            </th>
                            <th class="p-4 whitespace-nowrap bg-retroPaper/50">æ—¥æœŸ</th>
                            <th class="p-4 whitespace-nowrap bg-retroPaper/50">æ¯”è³½åç¨±</th>
                            <th class="p-4 whitespace-nowrap bg-retroPaper/50">çƒå ´</th>
                            <th class="p-4 whitespace-nowrap bg-retroPaper/50">å°æ‰‹</th>
                            <th v-for="col in displayColumns" :key="col.key" class="p-4 whitespace-nowrap text-center cursor-pointer hover:bg-retroText/10 bg-retroPaper/50" @click="sortBy(col.key)">
                                {{ col.label }}
                            </th>
                            <th class="p-4 whitespace-nowrap text-right bg-retroPaper/50">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-retroText/10 divide-dashed text-sm font-sans font-bold text-retroText/80">
                        <tr v-for="(log, index) in filteredLogs" :key="log.id" class="hover:bg-retroPaper/50 transition-colors group" :class="{'bg-retroGreen/10': selectedIds.has(log.id)}">
                            <td class="p-4 text-center">
                                <input type="checkbox" :checked="selectedIds.has(log.id)" @change="toggleSelect(log.id)">
                            </td>
                            <td class="p-4 whitespace-nowrap font-serif text-retroText font-black">{{ log.date }}</td>
                            <td class="p-4 whitespace-nowrap">{{ log.gameName }}</td>
                            <td class="p-4 whitespace-nowrap text-retroText/60">{{ log.stadium || '-' }}</td>
                            <td class="p-4 whitespace-nowrap">{{ log.opponent }}</td>
                            <td v-for="col in displayColumns" :key="col.key" class="p-4 whitespace-nowrap text-center font-serif text-lg">
                                {{ log[col.key] }}
                            </td>
                            <td class="p-4 whitespace-nowrap text-right space-x-3 opacity-60 group-hover:opacity-100 transition-opacity">
                                <button @click="editLog(log)" class="text-retroBlue hover:text-retroText font-bold underline decoration-2 decoration-retroBlue/30 hover:decoration-retroText">ç·¨è¼¯</button>
                                <button @click="deleteLog(log.id)" class="text-retroAccent hover:text-retroText font-bold underline decoration-2 decoration-retroAccent/30 hover:decoration-retroText">åˆªé™¤</button>
                            </td>
                        </tr>
                        <tr v-if="filteredLogs.length === 0">
                            <td :colspan="displayColumns.length + 6" class="p-16 text-center text-retroText/60 italic font-serif text-lg bg-retroPaper/20">
                                <div class="mb-4 text-6xl opacity-20 transform rotate-12">âš¾</div>
                                <p>å°šæœªæœ‰ç´€éŒ„ï¼Œè«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ‚¨çš„é‡çƒæ—¥è¨˜ã€‚</p>
                                <span class="text-xs text-retroGreen mt-4 block opacity-80 font-bold tracking-wide" v-if="isFirebaseMode">â˜ ç³»çµ±å·²é€£æ¥é›²ç«¯è³‡æ–™åº«</span>
                                <span class="text-xs text-retroText mt-4 block opacity-80 font-bold tracking-wide" v-else>ğŸ’¾ æœ¬åœ°å„²å­˜æ¨¡å¼ (å»ºè­°å®šæœŸå‚™ä»½)</span>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot v-if="filteredLogs.length > 0" class="bg-retroText/5 font-black text-retroText border-t-2 border-retroText/20">
                        <tr>
                            <td colspan="5" class="p-4 text-right font-serif text-base">ç¸½è¨ˆ / å¹³å‡</td>
                            <td v-for="col in displayColumns" :key="col.key" class="p-4 text-center font-sans text-base">
                                {{ calculateTotal(col.key) }}
                            </td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </section>
        
        <!-- Distribution Charts -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-8" v-if="logs.length > 0">
            <div class="card h-80 border-2 border-dashed border-retroGreen/30">
                <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-8 h-8 bg-retroGreen/20 rounded-full border border-retroGreen/40 flex items-center justify-center text-xs font-bold text-retroGreen">1</div>
                <h4 class="font-serif font-bold text-lg mb-4 text-center text-retroText border-b-2 border-retroText/10 pb-2">
                    {{ currentTab === 'batting' ? 'å®‰æ‰“é¡å‹åˆ†ä½ˆ' : 'å¥½å£çƒ/ä¸‰æŒ¯ä¿é€ä½”æ¯”' }}
                </h4>
                <div class="h-56 flex justify-center">
                    <canvas id="distChart1"></canvas>
                </div>
            </div>
            <div class="card h-80 border-2 border-dashed border-retroBlue/30">
                <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-8 h-8 bg-retroBlue/20 rounded-full border border-retroBlue/40 flex items-center justify-center text-xs font-bold text-retroBlue">2</div>
                 <h4 class="font-serif font-bold text-lg mb-4 text-center text-retroText border-b-2 border-retroText/10 pb-2">
                    {{ currentTab === 'batting' ? 'çµæœåˆ†ä½ˆ (ä¸Šå£˜ vs å‡ºå±€)' : 'æŠ•çƒçµæœåˆ†ä½ˆ' }}
                 </h4>
                <div class="h-56 flex justify-center">
                    <canvas id="distChart2"></canvas>
                </div>
            </div>
        </section>

        <!-- Bottom Data Management Section -->
        <footer class="mt-8 border-t-2 border-retroText/10 border-dashed pt-8 pb-12">
            <div class="text-center mb-6">
                <h4 class="font-serif font-black text-retroText text-lg mb-1 tracking-widest">è³‡æ–™ç®¡ç†å€</h4>
                <p class="text-[10px] text-retroText/50 tracking-[0.3em]">DATA MANAGEMENT</p>
            </div>
            <div class="flex flex-wrap justify-center gap-4">
                <div class="relative group">
                    <label class="btn-sketch cursor-pointer flex items-center gap-2">
                        <span class="text-lg">â†©</span>
                        <span class="inline sm:hidden">é‚„åŸ</span>
                        <span class="hidden sm:inline">é‚„åŸå‚™ä»½ (JSON)</span>
                        <input type="file" @change="handleFileUpload" accept=".json" class="hidden">
                    </label>
                </div>
                <button @click="exportData" class="btn-sketch flex items-center gap-2" title="åŒ¯å‡º JSON å‚™ä»½æª”"> 
                    <span class="text-lg">ğŸ’¾</span>
                    <span class="inline sm:hidden">å‚™ä»½</span>
                    <span class="hidden sm:inline">åŒ¯å‡ºå‚™ä»½</span> 
                </button>
                <button @click="showHelp = true" class="btn-sketch flex items-center gap-2" title="æŸ¥çœ‹æª”æ¡ˆæ ¼å¼èªªæ˜"> 
                    <span class="text-lg">ğŸ“–</span>
                    <span class="inline sm:hidden">èªªæ˜</span>
                    <span class="hidden sm:inline">åŒ¯å…¥èªªæ˜</span> 
                </button>
            </div>
        </footer>

    </main>

    <!-- Modal Form -->
    <div v-if="showForm" class="fixed inset-0 bg-retroText/40 backdrop-blur-sm flex justify-center items-center z-50 p-4">
        <div class="bg-retroPaper rounded-sm shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto animate-pop-in border-4 border-retroWhite ring-4 ring-retroText/5 relative">
            <div class="p-6 border-b-2 border-retroText/10 flex justify-between items-center bg-retroPaper sticky top-0 z-10 border-dashed">
                <h2 class="font-serif text-2xl font-black text-retroText flex items-center gap-2">
                    <span class="text-retroGreen text-3xl">âš¾</span> {{ isEditing ? 'ç·¨è¼¯ç´€éŒ„' : 'æ–°å¢ç´€éŒ„' }}
                </h2>
                <button @click="showForm = false" class="text-3xl text-retroText/40 hover:text-retroAccent font-bold transition-transform hover:rotate-90">&times;</button>
            </div>
            <form @submit.prevent="submitForm" class="p-8 grid grid-cols-1 md:grid-cols-2 gap-8 bg-retroWhite/40">
                <!-- Common Fields -->
                <div class="md:col-span-2 grid grid-cols-2 gap-6 p-4 bg-white/60 rounded-sm border border-retroText/5 shadow-sm">
                    <div>
                        <label class="block text-xs font-bold text-retroText/70 mb-1 font-serif uppercase tracking-wide">æ—¥æœŸ Date</label>
                        <input v-model="formData.date" type="date" required class="input-field">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-retroText/70 mb-1 font-serif uppercase tracking-wide">æ¯”è³½åç¨± Game</label>
                        <input v-model="formData.gameName" type="text" placeholder="ä¾‹ï¼šä¾‹è¡Œè³½ G1" class="input-field">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-retroText/70 mb-1 font-serif uppercase tracking-wide">çƒå ´ Stadium</label>
                        <input v-model="formData.stadium" type="text" placeholder="ä¾‹ï¼šè‡ºåŒ—å¤§å·¨è›‹" class="input-field">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-retroText/70 mb-1 font-serif uppercase tracking-wide">å°æ‰‹ Opponent</label>
                        <input v-model="formData.opponent" type="text" placeholder="å°æ‰‹éšŠå" class="input-field">
                    </div>
                </div>

                <div class="md:col-span-2 flex items-center gap-4">
                    <span class="h-px flex-1 bg-retroText/10 border-t border-dashed border-retroText/20"></span>
                    <span class="text-xs font-bold text-retroText/50 font-serif">è©³ç´°æ•¸æ“š STATS</span>
                    <span class="h-px flex-1 bg-retroText/10 border-t border-dashed border-retroText/20"></span>
                </div>

                <template v-if="currentTab === 'batting'">
                    <div v-for="field in battingFields" :key="field.key">
                        <label class="block text-xs font-bold text-retroText/60 mb-1 font-serif">{{ field.label }}</label>
                        <input v-model.number="formData[field.key]" type="number" min="0" class="input-field bg-white/50 focus:bg-white">
                    </div>
                </template>
                <template v-else>
                    <div v-for="field in pitchingFields" :key="field.key">
                        <label class="block text-xs font-bold text-retroText/60 mb-1 font-serif">
                            {{ field.label }} 
                            <span v-if="field.key === 'IP'" class="text-[10px] text-retroAccent font-normal ml-1">Example: 5.1</span>
                        </label>
                        <input v-model.number="formData[field.key]" type="number" step="0.1" min="0" class="input-field bg-white/50 focus:bg-white">
                    </div>
                </template>
                
                <div class="md:col-span-2 mt-4 flex gap-4 pt-6 border-t-2 border-retroText/10 border-dashed">
                    <button type="submit" class="flex-1 btn-primary text-lg">{{ isEditing ? 'ä¿å­˜ä¿®æ”¹' : 'å¯«å…¥æ—¥è¨˜' }}</button>
                    <button type="button" @click="showForm = false" class="flex-1 btn-sketch text-retroText/60 border-retroText/20 hover:border-retroText/50">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Help Modal -->
    <div v-if="showHelp" class="fixed inset-0 bg-retroText/40 backdrop-blur-sm flex justify-center items-center z-50 p-4">
        <div class="bg-retroPaper rounded-sm shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col animate-pop-in border-4 border-retroWhite ring-4 ring-retroText/5 relative">
            <!-- è£é£¾ï¼šé ‚éƒ¨è† å¸¶ -->
            <div class="absolute -top-4 left-1/2 -translate-x-1/2 w-1/3 h-8 bg-retroPaper/80 border border-retroText/10 shadow-sm rotate-[1.5deg] z-20 pointer-events-none"></div>

            <div class="p-6 border-b-2 border-retroText/10 flex justify-between items-center flex-shrink-0 bg-retroPaper sticky top-0 z-10 border-dashed">
                <h2 class="font-serif text-xl font-black text-retroText">ğŸ“– æª”æ¡ˆåŠŸèƒ½èªªæ˜</h2>
                <button @click="showHelp = false" class="text-2xl text-retroText/50 hover:text-retroAccent font-bold transition-transform hover:rotate-90">&times;</button>
            </div>
            
            <div class="p-6 text-sm text-retroText modal-body space-y-6 bg-retroWhite/40">
                <div class="bg-retroGreen/10 p-4 rounded-sm border-l-4 border-retroGreen shadow-sm">
                    <h4 class="font-bold text-retroGreen mb-2 font-serif text-base">è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h4>
                    <p class="mb-2 font-medium"><strong>åŒ¯å‡ºå‚™ä»½ï¼š</strong> é»æ“Šã€ŒåŒ¯å‡ºå‚™ä»½ã€æŒ‰éˆ•ï¼Œç³»çµ±æœƒä¸‹è¼‰ä¸€å€‹ <code>.json</code> æª”æ¡ˆã€‚è«‹å¦¥å–„ä¿å­˜æ­¤æª”æ¡ˆã€‚</p>
                    <p class="font-medium"><strong>é‚„åŸå‚™ä»½ï¼š</strong> é»æ“Šã€Œé‚„åŸå‚™ä»½ã€æŒ‰éˆ•ä¸¦é¸æ“‡æ‚¨çš„ <code>.json</code> å‚™ä»½æª”ï¼Œå³å¯å°‡è³‡æ–™é‚„åŸã€‚</p>
                </div>

                <div>
                    <p class="font-bold text-retroText/80 mb-2 font-serif border-b border-retroText/20 inline-block pb-1">CSV / Excel åŒ¯å…¥é€šç”¨æ¬„ä½</p>
                    <div class="bg-retroWhite p-4 rounded-sm border-2 border-retroText/10 shadow-sm border-dashed font-serif text-retroText/80">
                        <p class="leading-relaxed font-bold">
                            â€¢ æ—¥æœŸ <span class="font-sans font-normal text-xs opacity-60">(Date)</span><br>
                            â€¢ æ¯”è³½åç¨± <span class="font-sans font-normal text-xs opacity-60">(Game)</span><br>
                            â€¢ æ¯”è³½çƒå ´ <span class="font-sans font-normal text-xs opacity-60">(Stadium)</span><br>
                            â€¢ å°æ‰‹ <span class="font-sans font-normal text-xs opacity-60">(Opponent)</span>
                        </p>
                    </div>
                </div>
                 <div v-if="currentTab === 'batting'">
                    <h4 class="font-bold text-retroText mb-2 mt-2 font-serif">æ‰“æ“Šæ•¸æ“šå°ç…§è¡¨</h4>
                    <table class="w-full text-left border-collapse bg-retroWhite shadow-sm border-2 border-retroText/10 border-dashed">
                        <tr class="bg-retroText/5 text-retroText"><th class="p-2 border-b border-retroText/10 border-dashed font-serif">ä»£ç¢¼/ä¸­æ–‡</th><th class="p-2 border-b border-retroText/10 border-dashed font-serif">èªªæ˜</th></tr>
                        <tr><td class="p-2 border-b border-retroText/5 border-dashed font-bold">PA, æ‰“å¸­</td><td class="p-2 border-b border-retroText/5 border-dashed">æ‰“å¸­</td></tr>
                        <tr><td class="p-2 border-b border-retroText/5 border-dashed font-bold">AB, æ‰“æ•¸</td><td class="p-2 border-b border-retroText/5 border-dashed">æ‰“æ•¸</td></tr>
                        <tr><td class="p-2 border-b border-retroText/5 border-dashed font-bold">H, å®‰æ‰“</td><td class="p-2 border-b border-retroText/5 border-dashed">å®‰æ‰“ (ç¸½æ•¸)</td></tr>
                    </table>
                </div>
                <div v-if="currentTab === 'pitching'">
                    <h4 class="font-bold text-retroText mb-2 mt-2 font-serif">æŠ•çƒæ•¸æ“šå°ç…§è¡¨</h4>
                    <table class="w-full text-left border-collapse bg-retroWhite shadow-sm border-2 border-retroText/10 border-dashed">
                        <tr class="bg-retroBlue/10 text-retroText"><th class="p-2 border-b border-retroText/10 border-dashed font-serif">ä»£ç¢¼/ä¸­æ–‡</th><th class="p-2 border-b border-retroText/10 border-dashed font-serif">èªªæ˜</th></tr>
                        <tr><td class="p-2 border-b border-retroText/5 border-dashed font-bold">IP, å±€æ•¸</td><td class="p-2 border-b border-retroText/5 border-dashed">å±€æ•¸</td></tr>
                        <tr><td class="p-2 border-b border-retroText/5 border-dashed font-bold">W, å‹</td><td class="p-2 border-b border-retroText/5 border-dashed">å‹æŠ•</td></tr>
                        <tr><td class="p-2 border-b border-retroText/5 border-dashed font-bold">H, è¢«å®‰æ‰“</td><td class="p-2 border-b border-retroText/5 border-dashed">è¢«å®‰æ‰“</td></tr>
                    </table>
                </div>
            </div>
            <div class="p-4 border-t-2 border-retroText/10 text-center flex-shrink-0 bg-retroPaper/80 border-dashed">
                <button @click="showHelp = false" class="btn-primary w-full shadow-none border-b-2">æˆ‘çŸ¥é“äº†</button>
            </div>
        </div>
    </div>

    <!-- Custom Dialog Modal -->
    <div v-if="dialog.show" class="fixed inset-0 bg-retroText/40 backdrop-blur-sm flex justify-center items-center z-[60] p-4">
        <div class="bg-retroPaper rounded-sm shadow-paper-pop w-full max-w-sm flex flex-col overflow-hidden animate-pop-in border-4 border-retroWhite ring-4 ring-retroText/5 relative">
            <div class="p-8 text-center bg-retroWhite/40">
                <div class="text-6xl mb-4 text-retroText/80">{{ dialog.icon }}</div>
                <h3 class="font-serif text-2xl font-black text-retroText mb-3">{{ dialog.title }}</h3>
                <p class="text-retroText/80 text-sm leading-relaxed font-bold font-serif">{{ dialog.message }}</p>
            </div>
            <div class="flex border-t-2 border-retroText/10 border-dashed">
                <button v-if="dialog.isConfirm" @click="dialog.show = false" class="flex-1 py-4 text-retroText/60 hover:bg-retroText/5 transition font-bold font-serif">å–æ¶ˆ</button>
                <div v-if="dialog.isConfirm" class="w-0.5 bg-retroText/10 border-r border-dashed border-retroText/20"></div>
                <button @click="handleDialogConfirm" :class="['flex-1 py-4 text-retroWhite transition font-bold font-serif', dialog.isConfirm ? 'bg-retroAccent hover:bg-retroAccent/90' : 'bg-retroGreen hover:bg-retroGreen/90']">
                    {{ dialog.confirmText || 'ç¢ºå®š' }}
                </button>
            </div>
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, writeBatch } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // Firebase setup
            let isFirebaseAvailable = false;
            let db = null;
            let auth = null;
            let appId = 'default-app-id';

            try {
                if (typeof __firebase_config !== 'undefined') {
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    isFirebaseAvailable = true;
                }
            } catch (e) {
                console.warn("Firebase Init Skipped: Running in Local Mode");
            }

            const isFirebaseMode = ref(isFirebaseAvailable);
            const user = ref(null);
            
            if (typeof ChartDataLabels !== 'undefined') {
                Chart.register(ChartDataLabels);
            }

            const currentTab = ref('batting');
            const showForm = ref(false);
            const showHelp = ref(false);
            const isEditing = ref(false);
            const searchQuery = ref('');
            const logs = ref([]);
            const selectedIds = ref(new Set());
            const chartMode = ref('trend');
            
            const dialog = ref({ show: false, title: '', message: '', icon: '', isConfirm: false, confirmText: '', onConfirm: null });

            let trendChartInstance = null;
            let distChart1Instance = null;
            let distChart2Instance = null;

            const defaultFormData = {
                date: new Date().toISOString().split('T')[0], gameName: '', stadium: '', opponent: '',
                PA: 0, AB: 0, H: 0, B2: 0, B3: 0, HR: 0, RBI: 0, BB: 0, SO: 0, SF: 0, SB: 0,
                IP: 0, H_p: 0, R: 0, ER: 0, BB_p: 0, SO_p: 0, HR_p: 0, W: 0, L: 0, SV: 0
            };
            const formData = ref({ ...defaultFormData });

            const battingFields = [
                { key: 'PA', label: 'æ‰“å¸­ (PA)' }, { key: 'AB', label: 'æ‰“æ•¸ (AB)' },
                { key: 'H', label: 'å®‰æ‰“ (H)' }, { key: 'B2', label: 'äºŒå£˜æ‰“ (2B)' },
                { key: 'B3', label: 'ä¸‰å£˜æ‰“ (3B)' }, { key: 'HR', label: 'å…¨å£˜æ‰“ (HR)' },
                { key: 'RBI', label: 'æ‰“é» (RBI)' }, { key: 'BB', label: 'å››å£ (BB)' },
                { key: 'SO', label: 'ä¸‰æŒ¯ (SO)' }, { key: 'SB', label: 'ç›œå£˜ (SB)' },
                { key: 'SF', label: 'é«˜é£›çŠ§ç‰² (SF)' }
            ];
            const pitchingFields = [
                { key: 'W', label: 'å‹ (W)' }, { key: 'L', label: 'æ•— (L)' },
                { key: 'IP', label: 'å±€æ•¸ (IP)' }, { key: 'H_p', label: 'è¢«å®‰æ‰“ (H)' },
                { key: 'R', label: 'å¤±åˆ† (R)' }, { key: 'ER', label: 'è²¬å¤± (ER)' },
                { key: 'BB_p', label: 'å››å£ (BB)' }, { key: 'SO_p', label: 'ä¸‰æŒ¯ (K)' },
                { key: 'HR_p', label: 'è¢«å…¨å£˜æ‰“ (HR)' }
            ];

            const displayColumns = computed(() => {
                if (currentTab.value === 'batting') return [{key:'AB',label:'AB'},{key:'H',label:'H'},{key:'HR',label:'HR'},{key:'RBI',label:'RBI'},{key:'AVG',label:'AVG'},{key:'OPS',label:'OPS'}];
                return [{key:'IP',label:'IP'},{key:'H_p',label:'H'},{key:'ER',label:'ER'},{key:'SO_p',label:'K'},{key:'BB_p',label:'BB'},{key:'ERA',label:'ERA'},{key:'WHIP',label:'WHIP'}];
            });

            const filteredLogs = computed(() => {
                let data = logs.value.filter(l => l.type === currentTab.value);
                if (searchQuery.value) {
                    const q = searchQuery.value.toLowerCase();
                    data = data.filter(l => l.opponent?.toLowerCase().includes(q) || l.gameName?.toLowerCase().includes(q) || l.stadium?.toLowerCase().includes(q));
                }
                return data.map(log => ({ ...log, ...calculateStats(log) })).sort((a, b) => new Date(b.date) - new Date(a.date));
            });

            const isAllSelected = computed(() => filteredLogs.value.length > 0 && filteredLogs.value.every(log => selectedIds.value.has(log.id)));

            const mainStat = computed(() => {
                const data = filteredLogs.value;
                if (data.length === 0) return '---';
                if (currentTab.value === 'batting') {
                    const h = data.reduce((s, i) => s + (i.H || 0), 0);
                    const ab = data.reduce((s, i) => s + (i.AB || 0), 0);
                    return ab === 0 ? '.000' : (h / ab).toFixed(3).replace(/^0+/, '');
                } else {
                    const er = data.reduce((s, i) => s + (i.ER || 0), 0);
                    const outs = data.reduce((s, i) => s + convertIPtoOuts(i.IP), 0);
                    return outs === 0 ? '0.00' : (er * 9 / (outs/3)).toFixed(2);
                }
            });

            const secondaryStat = computed(() => {
                const data = filteredLogs.value;
                if (data.length === 0) return '---';
                if (currentTab.value === 'batting') {
                    const ab = data.reduce((s, i) => s + (i.AB || 0), 0);
                    const h = data.reduce((s, i) => s + (i.H || 0), 0);
                    const bb = data.reduce((s, i) => s + (i.BB || 0), 0);
                    const pa = data.reduce((s, i) => s + (i.PA || 0), 0);
                    const tb = data.reduce((s, i) => s + (i.H + (i.B2||0) + 2*(i.B3||0) + 3*(i.HR||0)), 0);
                    const obp = pa === 0 ? 0 : (h + bb) / pa;
                    const slg = ab === 0 ? 0 : tb / ab;
                    return (obp + slg).toFixed(3).replace(/^0+/, '');
                } else {
                    const outs = data.reduce((s, i) => s + convertIPtoOuts(i.IP), 0);
                    const wh = data.reduce((s, i) => s + (i.BB_p || 0) + (i.H_p || 0), 0);
                    return outs === 0 ? '0.00' : (wh / (outs/3)).toFixed(2);
                }
            });

            onMounted(() => {
                if (isFirebaseAvailable) {
                    const initAuth = async () => {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (err) { console.error("Auth failed", err); }
                    };
                    initAuth();
                    onAuthStateChanged(auth, (u) => {
                        user.value = u;
                        if (u) {
                            const q = collection(db, 'artifacts', appId, 'public', 'data', 'baseball_logs');
                            onSnapshot(q, (snapshot) => {
                                logs.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            });
                        }
                    });
                } else {
                    const saved = localStorage.getItem('baseball_logs');
                    if (saved) logs.value = JSON.parse(saved);
                    else {
                        logs.value = [
                            { id: 1, type: 'batting', date: '2023-10-01', gameName: 'ç¯„ä¾‹è³½', stadium: 'å°åŒ—', opponent: 'æ¸¬è©¦éšŠ', PA: 4, AB: 3, H: 1, B2: 0, B3: 0, HR: 0, RBI: 0, BB: 1, SO: 0, SF: 0, SB: 0 }
                        ];
                    }
                }
                renderCharts();
            });

            function exportData() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(logs.value));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "baseball_data_backup.json");
                document.body.appendChild(downloadAnchorNode); 
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }

            function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    let newLogs = [];
                    if (file.name.endsWith('.json')) {
                        try {
                            const json = JSON.parse(e.target.result);
                            if (Array.isArray(json)) newLogs = json;
                            else { showAlert('éŒ¯èª¤', 'JSON æ ¼å¼ä¸æ­£ç¢º'); return; }
                        } catch(err) { showAlert('éŒ¯èª¤', 'ç„¡æ³•è§£æ JSON æª”æ¡ˆ'); return; }
                    } else {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet, { defval: 0 });
                        if(!json.length) { showAlert('éŒ¯èª¤','ç„¡è³‡æ–™'); return; }
                        
                        const getVal = (row, keys) => {
                            for (let key of keys) { if (row[key] !== undefined) return row[key]; }
                            const rowKeys = Object.keys(row);
                            for (let key of keys) {
                                const foundKey = rowKeys.find(k => k.toLowerCase().trim() === key.toLowerCase().trim());
                                if (foundKey) return row[foundKey];
                            }
                            return 0; 
                        };
                        const getStringVal = (row, keys, defaultVal = '') => {
                             const val = getVal(row, keys);
                             return (val === 0 || val === undefined) ? defaultVal : String(val);
                        }

                        newLogs = json.map(row => {
                            let dateVal = getVal(row, ['Date', 'æ—¥æœŸ', 'date']);
                            if (typeof dateVal === 'number' && dateVal > 20000) {
                                dateVal = new Date(Math.round((dateVal - 25569)*86400*1000)).toISOString().split('T')[0];
                            } else if (!dateVal) {
                                dateVal = new Date().toISOString().split('T')[0];
                            } else {
                                try { dateVal = new Date(dateVal).toISOString().split('T')[0]; } 
                                catch(e) { dateVal = new Date().toISOString().split('T')[0]; }
                            }

                            return { 
                                type: currentTab.value, 
                                date: dateVal,
                                gameName: getStringVal(row, ['Game', 'æ¯”è³½åç¨±', 'æ¯”è³½', 'Event'], 'åŒ¯å…¥è³½äº‹'),
                                stadium: getStringVal(row, ['Stadium', 'çƒå ´', 'åœ°é»', 'Place'], ''),
                                opponent: getStringVal(row, ['Opponent', 'å°æ‰‹', 'VS'], ''),
                                PA: Number(getVal(row, ['PA', 'æ‰“å¸­'])) || 0, AB: Number(getVal(row, ['AB', 'æ‰“æ•¸'])) || 0, H: Number(getVal(row, ['H', 'å®‰æ‰“', 'å®‰'])) || 0, B2: Number(getVal(row, ['2B', 'äºŒå£˜æ‰“', 'äºŒå®‰'])) || 0, B3: Number(getVal(row, ['3B', 'ä¸‰å£˜æ‰“', 'ä¸‰å®‰'])) || 0, HR: Number(getVal(row, ['HR', 'å…¨å£˜æ‰“', 'è½Ÿ'])) || 0, RBI: Number(getVal(row, ['RBI', 'æ‰“é»'])) || 0, BB: Number(getVal(row, ['BB', 'å››å£', 'ä¿é€'])) || 0, SO: Number(getVal(row, ['SO', 'K', 'ä¸‰æŒ¯'])) || 0, SB: Number(getVal(row, ['SB', 'ç›œå£˜'])) || 0, SF: Number(getVal(row, ['SF', 'é«˜é£›çŠ§ç‰²', 'çŠ§é£›'])) || 0,
                                IP: Number(getVal(row, ['IP', 'å±€æ•¸'])) || 0, W: Number(getVal(row, ['W', 'å‹', 'å‹æŠ•'])) || 0, L: Number(getVal(row, ['L', 'æ•—', 'æ•—æŠ•'])) || 0, SV: Number(getVal(row, ['SV', 'S', 'æ•‘æ´', 'æ•‘æ´æˆåŠŸ'])) || 0, H_p: Number(getVal(row, ['H', 'è¢«å®‰æ‰“', 'å®‰æ‰“'])) || 0, R: Number(getVal(row, ['R', 'å¤±åˆ†'])) || 0, ER: Number(getVal(row, ['ER', 'è²¬å¤±', 'è²¬å¤±åˆ†'])) || 0, BB_p: Number(getVal(row, ['BB', 'å››å£', 'ä¿é€'])) || 0, SO_p: Number(getVal(row, ['SO', 'K', 'ä¸‰æŒ¯'])) || 0, HR_p: Number(getVal(row, ['HR', 'è¢«å…¨å£˜æ‰“', 'å…¨å£˜æ‰“'])) || 0
                            }; 
                        });
                    }

                    if(isFirebaseAvailable) {
                        const batch = writeBatch(db);
                        newLogs.forEach(l => { const { id, ...cleanData } = l; batch.set(doc(collection(db,'artifacts',appId,'public','data','baseball_logs')), cleanData); });
                        await batch.commit();
                    } else {
                        newLogs.forEach(l => { l.id = Date.now() + Math.random(); logs.value.push(l); });
                        localStorage.setItem('baseball_logs', JSON.stringify(logs.value));
                    }
                    showAlert('æˆåŠŸ', `å·²åŒ¯å…¥/é‚„åŸ ${newLogs.length} ç­†è³‡æ–™`);
                    event.target.value = '';
                };
                if (file.name.endsWith('.json')) reader.readAsText(file);
                else reader.readAsArrayBuffer(file);
            }

            async function submitForm() {
                const payload = { ...formData.value, type: currentTab.value };
                if (isFirebaseAvailable && user.value) {
                    try {
                        const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'baseball_logs');
                        if (isEditing.value && payload.id) {
                            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'baseball_logs', payload.id);
                            const { id, ...data } = payload;
                            await updateDoc(docRef, data);
                        } else { delete payload.id; await addDoc(colRef, payload); }
                    } catch (e) { showAlert('éŒ¯èª¤', 'é›²ç«¯å„²å­˜å¤±æ•—'); }
                } else {
                    if (isEditing.value) { const idx = logs.value.findIndex(l => l.id === payload.id); if (idx !== -1) logs.value[idx] = payload; } 
                    else { payload.id = Date.now(); logs.value.push(payload); }
                    localStorage.setItem('baseball_logs', JSON.stringify(logs.value));
                }
                showForm.value = false; resetForm();
            }

            async function deleteLog(id) {
                showConfirm('åˆªé™¤ç¢ºèª', 'ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ', async () => {
                    if (isFirebaseAvailable && user.value) { try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'baseball_logs', id)); } catch(e){} } 
                    else { logs.value = logs.value.filter(l => l.id !== id); localStorage.setItem('baseball_logs', JSON.stringify(logs.value)); }
                    if(selectedIds.value.has(id)) selectedIds.value.delete(id);
                });
            }

            async function deleteSelected() {
                showConfirm('åˆªé™¤ç¢ºèª', `åˆªé™¤ ${selectedIds.value.size} ç­†ï¼Ÿ`, async () => {
                    if (isFirebaseAvailable && user.value) {
                        const batch = writeBatch(db);
                        selectedIds.value.forEach(id => { batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'baseball_logs', id)); });
                        await batch.commit();
                    } else {
                        logs.value = logs.value.filter(l => !selectedIds.value.has(l.id));
                        localStorage.setItem('baseball_logs', JSON.stringify(logs.value));
                    }
                    selectedIds.value.clear();
                });
            }

            function convertIPtoOuts(ip) { const s = String(ip).split('.'); return (parseInt(s[0])*3) + (s[1]?parseInt(s[1]):0); }
            function convertOutsToIP(outs) { return (outs % 3 === 0) ? Math.floor(outs/3) : parseFloat(`${Math.floor(outs/3)}.${outs%3}`); }
            function calculateStats(log) {
                if (log.type === 'batting') {
                    const avg = log.AB ? log.H / log.AB : 0;
                    const single = log.H - (log.B2||0) - (log.B3||0) - (log.HR||0);
                    const tb = single + 2*(log.B2||0) + 3*(log.B3||0) + 4*(log.HR||0);
                    const slg = log.AB ? tb / log.AB : 0;
                    const obp = log.PA ? (log.H + log.BB) / log.PA : 0;
                    return { AVG: avg.toFixed(3).replace(/^0+/, ''), OPS: (obp+slg).toFixed(3).replace(/^0+/, '') };
                } else {
                    const outs = convertIPtoOuts(log.IP);
                    const era = outs ? (log.ER*9)/(outs/3) : 0;
                    const whip = outs ? (log.BB_p+log.H_p)/(outs/3) : 0;
                    return { ERA: era.toFixed(2), WHIP: whip.toFixed(2) };
                }
            }
            function calculateTotal(key) {
                if (['AVG','OPS','ERA','WHIP'].includes(key)) return '---';
                let total = filteredLogs.value.reduce((s, i) => s + (Number(i[key])||0), 0);
                return key === 'IP' ? convertOutsToIP(filteredLogs.value.reduce((s,i)=>s+convertIPtoOuts(i.IP),0)) : total;
            }
            function calculateGroupStat(groupLogs) {
                if (currentTab.value === 'batting') { const h = groupLogs.reduce((s,l)=>s+(l.H||0),0); const ab = groupLogs.reduce((s,l)=>s+(l.AB||0),0); return ab ? h/ab : 0; } 
                else { const er = groupLogs.reduce((s,l)=>s+(l.ER||0),0); const outs = groupLogs.reduce((s,l)=>s+convertIPtoOuts(l.IP),0); return outs ? er*9/(outs/3) : 0; }
            }
            function sortBy(k){ logs.value.sort((a,b)=>(b[k]||0)-(a[k]||0)); }
            function editLog(l){ formData.value={...l}; currentTab.value=l.type; isEditing.value=true; showForm.value=true; }
            function resetForm(){ formData.value={...defaultFormData, date: new Date().toISOString().split('T')[0]}; }
            function toggleSelectAll(e){ if(e.target.checked) filteredLogs.value.forEach(l=>selectedIds.value.add(l.id)); else selectedIds.value.forEach(l=>selectedIds.value.delete(l.id)); }
            function toggleSelect(id){ if(selectedIds.value.has(id)) selectedIds.value.delete(id); else selectedIds.value.add(id); }
            function showConfirm(t,m,cb){ dialog.value={show:true,title:t,message:m,icon:'ğŸ—‘ï¸',isConfirm:true,confirmText:'ç¢ºèª',onConfirm:cb}; }
            function showAlert(t,m,e=false){ dialog.value={show:true,title:t,message:m,icon:e?'âŒ':'âœ…',isConfirm:false,confirmText:'å¥½',onConfirm:null}; }
            function handleDialogConfirm(){ if(dialog.value.onConfirm) dialog.value.onConfirm(); dialog.value.show=false; }

            function renderCharts() {
                nextTick(() => {
                    const ctxTrend = document.getElementById('trendChart');
                    const ctxDist1 = document.getElementById('distChart1');
                    const ctxDist2 = document.getElementById('distChart2');
                    
                    if (trendChartInstance) { trendChartInstance.destroy(); trendChartInstance = null; }
                    if (distChart1Instance) { distChart1Instance.destroy(); distChart1Instance = null; }
                    if (distChart2Instance) { distChart2Instance.destroy(); distChart2Instance = null; }

                    if (!ctxTrend) return;

                    const primaryColor = '#8CA694'; // å¾©å¤ç¶ 
                    const secondaryColor = '#88A6B0'; // å¾©å¤è—

                    let labels, mainData, chartType;

                    if (chartMode.value === 'trend') {
                         const data = filteredLogs.value.slice().reverse();
                         labels = data.map(l => l.date.slice(5));
                         mainData = currentTab.value === 'batting' ? data.map(l=>calculateStats(l).AVG) : data.map(l=>calculateStats(l).ERA);
                         chartType = 'line';
                    } else {
                        const key = chartMode.value === 'game' ? 'gameName' : 'opponent';
                        const groups = {};
                        filteredLogs.value.forEach(l => { const k=l[key]||'æœªçŸ¥'; if(!groups[k]) groups[k]=[]; groups[k].push(l); });
                        labels = Object.keys(groups);
                        mainData = labels.map(k => calculateGroupStat(groups[k]));
                        chartType = 'bar';
                    }
                    
                    trendChartInstance = new Chart(ctxTrend, {
                        type: chartType,
                        data: {
                            labels: labels,
                            datasets: [{ 
                                label: currentTab.value==='batting'?'AVG':'ERA', 
                                data: mainData, 
                                borderColor: primaryColor, 
                                backgroundColor: chartType==='line'?'rgba(140, 166, 148, 0.2)':primaryColor, 
                                tension: 0.3, 
                                fill: chartType==='line',
                                borderWidth: 2,
                                pointBackgroundColor: '#F2E8D5',
                                pointBorderColor: primaryColor,
                                pointRadius: 4
                            }]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            plugins: { 
                                legend: {display:false}, 
                                datalabels: {display:false} 
                            }, 
                            scales: { 
                                y: {
                                    beginAtZero: chartType==='bar',
                                    grid: { color: 'rgba(115, 99, 87, 0.1)', borderDash: [5, 5] },
                                    ticks: { font: { family: "'Noto Sans TC', sans-serif" }, color: '#736357' }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { font: { family: "'Noto Sans TC', sans-serif" }, color: '#736357' }
                                }
                            } 
                        }
                    });

                    if (ctxDist1 && ctxDist2) {
                        const d = filteredLogs.value;
                        let d1, l1, d2, l2;
                        if(currentTab.value==='batting') {
                            const h=d.reduce((s,i)=>s+(i.H||0),0), bb=d.reduce((s,i)=>s+(i.BB||0),0), so=d.reduce((s,i)=>s+(i.SO||0),0);
                            l1=['å®‰æ‰“','ä¿é€','ä¸‰æŒ¯','å…¶ä»–']; d1=[h,bb,so,Math.max(0, d.reduce((s,i)=>s+(i.PA||0),0)-h-bb-so)];
                            const h1=d.reduce((s,i)=>s+((i.H||0)-(i.B2||0)-(i.B3||0)-(i.HR||0)),0);
                            l2=['ä¸€å®‰','äºŒå®‰','ä¸‰å®‰','å…¨å£˜æ‰“']; d2=[h1, d.reduce((s,i)=>s+(i.B2||0),0), d.reduce((s,i)=>s+(i.B3||0),0), d.reduce((s,i)=>s+(i.HR||0),0)];
                        } else {
                            l1=['ä¸‰æŒ¯','ä¿é€','å…¶ä»–']; d1=[d.reduce((s,i)=>s+(i.SO_p||0),0), d.reduce((s,i)=>s+(i.BB_p||0),0), Math.max(0, d.reduce((s,i)=>s+convertIPtoOuts(i.IP),0)-d.reduce((s,i)=>s+(i.SO_p||0),0))];
                            l2=['å‹','æ•—','æ•‘æ´']; d2=[d.reduce((s,i)=>s+(i.W||0),0), d.reduce((s,i)=>s+(i.L||0),0), d.reduce((s,i)=>s+(i.SV||0),0)];
                        }

                        // Retro Color Palette for Charts
                        const retroColors = ['#8CA694', '#88A6B0', '#D97C6E', '#736357'];

                        distChart1Instance = new Chart(ctxDist1, { 
                            type: 'doughnut', 
                            data: { labels: l1, datasets: [{ data: d1, backgroundColor: retroColors, borderColor: '#F2E8D5', borderWidth: 2 }] }, 
                            options: { 
                                responsive:true, maintainAspectRatio:false, 
                                plugins:{ 
                                    legend: { position: 'bottom', labels: { font: { family: "'Noto Sans TC', sans-serif" }, color: '#736357' } },
                                    datalabels:{ color:'#F2E8D5', font:{weight:'bold'}, formatter:(v,c)=>{let s=0;c.chart.data.datasets[0].data.map(n=>s+=n);return s?(v*100/s).toFixed(1)+'%':'';} } 
                                } 
                            } 
                        });
                        distChart2Instance = new Chart(ctxDist2, { 
                            type: 'bar', 
                            data: { labels: l2, datasets: [{ label:'æ•¸é‡', data: d2, backgroundColor: '#736357' }] }, 
                            options: { 
                                responsive:true, maintainAspectRatio:false, 
                                scales: { 
                                    y: { grid: { color: 'rgba(115, 99, 87, 0.1)', borderDash: [5, 5] }, ticks: { color: '#736357' } },
                                    x: { grid: { display: false }, ticks: { color: '#736357' } }
                                },
                                plugins:{ legend:{display:false}, datalabels:{display:false} } 
                            } 
                        });
                    }
                });
            }

            watch([currentTab, chartMode, logs], () => { renderCharts(); }, { deep: true });

            return {
                currentTab, showForm, showHelp, isEditing, formData, searchQuery, logs, selectedIds, chartMode,
                battingFields, pitchingFields, displayColumns, filteredLogs, mainStat, secondaryStat, isFirebaseMode,
                submitForm, editLog, deleteLog, deleteSelected, resetForm, handleFileUpload, calculateTotal, sortBy,
                dialog, handleDialogConfirm, exportData
            };
        }
    }).mount('#app');
</script>

</body>
</html>





